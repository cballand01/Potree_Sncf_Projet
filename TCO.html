<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- Métadonnées et configuration de la page -->
  <meta charset="utf-8">
  <title>PAR Sud-Est</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <!-- Chargement des polices Google -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Feuilles de styles pour Potree et autres bibliothèques -->
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/build/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/libs/jstree/themes/mixed/style.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/build/potree/custom.css">
  <link rel="stylesheet" type="text/css" href="https://raw.githubusercontent.com/cballand01/Potree_Sncf_Projet/refs/heads/main/build/potree/style_SNCF.css">
  
  <!-- Style spécifique pour le conteneur de l'image dans la popup -->
  <style>
    /* Style pour l'image dans la popup (largeur complète, débordement masqué) */
    #popupImageContainer {
      width: 100%;
      overflow: hidden;
      position: relative;
    }
  </style>
</head>

<body>
  <!-- Splash screen affiché au démarrage -->
  <div id="splash">
    <div class="loader"></div>
  </div>

  <!-- Boutons d'actions en mode Expert -->
  <div id="splat_buttons">
    <div id="pointBudgetContainer">
      <label for="pointBudgetSlider">Points affichés : <span id="pointBudgetValue">2 000 000</span></label>
      <input type="range" id="pointBudgetSlider" min="100000" max="10000000" step="100000" value="2000000">
    </div>
    <button id="toggleLissage">Désactiver lissage</button>
  </div>

  <!-- Boutons de contrôle pour la caméra et les outils -->
  <div id="buttonAndCameraContainer">
    <div id="cameraPosition" class="tooltip-container">
      <span class="custom-tooltip">Position de la caméra</span>
    </div>
    <div id="buttonsContainer">
      <!-- Bouton pour mesurer un point -->
      <div id="measureButton" class="buttonFrame tooltip-container tooltip-right">
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/Point.svg" alt="Mesurer">
        <span class="custom-tooltip">Mesurer un point</span>
      </div>
      <!-- Bouton pour supprimer les mesures -->
      <div id="deleteButton" class="buttonFrame tooltip-container tooltip-right">
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/reset_tools.svg" alt="Supprimer">
        <span class="custom-tooltip">Supprimer le/les point-s</span>
      </div>
      <!-- Bouton pour recentrer la vue -->
      <div id="recenterButton" class="buttonFrame tooltip-container tooltip-right">
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/eye-svgrepo-com.svg" alt="Recentrer">
        <span class="custom-tooltip">Recentrer la vue</span>
      </div>
      <!-- Bouton pour afficher les instructions de déplacement -->
      <div id="instructionButton" class="buttonFrame tooltip-container tooltip-right">
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/Souris.svg" alt="Instructions">
        <span class="custom-tooltip">Instructions de déplacement</span>
      </div>
      <!-- Bouton pour basculer en plein écran -->
      <div id="fullscreenButton" class="buttonFrame tooltip-container tooltip-right">
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/GrandEcran.svg" alt="Plein écran">
        <span class="custom-tooltip">Ouvrir/fermer le plein écran</span>
      </div>
    </div>
  </div>

  <!-- Slidebar latérale avec menu et informations -->
  <div id="slidebar">
    <div id="slidebarToggle">
      <img src="/Potree_Sncf_Projet/build/potree/resources/icons/menu_button.svg" class="potree_menu_toggle">
    </div>
    <div class="slidebar-header">
      <a href="https://potree.org" target="_blank">potree.org - github</a>
      <span class="slidebar-version">1.8.0</span>
    </div>
    <div class="slidebar-content">
      <!-- Accordéon pour les informations sur le projet -->
      <div class="accordion-item">
        <div class="accordion-header">Informations sur le projet</div>
        <div class="accordion-content">
          <p>
            Le projet est né d'une collaboration entre la SNCF, l'INSA de Strasbourg et Charles Balland, alliant l'expertise du secteur ferroviaire à l'innovation technologique académique. Ensemble, ils ont imaginé une solution innovante pour visualiser et analyser des données 3D, visant à optimiser la gestion des infrastructures.
          </p>
        </div>
      </div>
      <!-- Accordéon pour les informations sur Potree -->
      <div class="accordion-item">
        <div class="accordion-header">Informations sur Potree</div>
        <div class="accordion-content">
          <p>
            Potree est une bibliothèque open source qui permet de visualiser de grands nuages de points en 3D directement dans votre navigateur grâce à la technologie WebGL. Conçu pour gérer des ensembles de données volumineux (comme ceux issus de relevés LiDAR), Potree offre une navigation fluide et interactive, idéale pour explorer, analyser et partager des modèles 3D détaillés.
          </p>
        </div>
      </div>
      <!-- Accordéon pour présenter une journée au PAR -->
      <div class="accordion-item">
        <div class="accordion-header">Une journée au PAR</div>
        <div class="accordion-content">
          <p>
            Plongez au cœur d'une journée captivante au PAR de la ligne à grande vitesse Paris-Lyon, située au centre Henri Lang à Paris. Découvrez en immersion totale les coulisses d'une infrastructure moderne et innovante, où chaque instant révèle les défis et les succès d'une technologie de pointe. Vivez une expérience unique qui vous connecte au futur de la mobilité, entre passion et ingénierie de haut vol.
          </p>
          <!-- Miniature vidéo cliquable -->
          <img id="videoThumbnail" src="/Potree_Sncf_Projet/build/potree/resources/images/Miniature.jpeg" alt="Miniature vidéo" style="width:100%; cursor:pointer;">
        </div>
      </div>
    </div>
    <!-- Logo Potree en bas de la slidebar -->
    <div class="slidebar-logo">
      <img src="/Potree_Sncf_Projet/build/potree/resources/logo.svg" alt="Logo Potree">
    </div>
  </div>

  <!-- Zone principale de rendu Potree -->
  <div class="potree_container">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <!-- Popup pour l'affichage des images agrandies -->
  <div id="imagePopup" style="display: none;">
    <div id="popupContent">
      <span class="closePopup">&times;</span>
      <div id="popupImageContainer">
        <img id="popupImage" src="" alt="Image agrandie">
      </div>
      <div id="popupText"></div>
    </div>
  </div>

  <!-- Fenêtre de bienvenue avec choix de mode (visite guidée ou exploration libre) -->
  <div id="welcomePopup">
    <div id="welcomePopupContent">
      <h2>Bienvenue au Poste d'Aiguillage et de Régulation de la ligne Paris-Lyon !</h2>
      <p>Choisissez votre mode d'utilisation :</p>
      <button id="btnSimplified">Visite guidée</button>
      <button id="btnExpert">Explorer librement</button>
    </div>
  </div>
  

  <!-- Popup pour la lecture de vidéo -->
  <div id="videoPopup">
    <div id="videoPopupContent">
      <span class="closeVideoPopup">&times;</span>
      <video id="popupVideo" controls style="width:100%; max-height:80vh; border-radius:4px;">
        <source src="" type="video/mp4">
        Votre navigateur ne supporte pas la vidéo.
      </video>
      <div id="popupVideoText" style="color:#000; font-size:14px; line-height:1.4;"></div>
    </div>
  </div>

  <!-- Popup pour les instructions de navigation -->
  <div id="instructionPopup">
    <div id="instructionPopupContent">
      <span class="closeInstructionPopup">&times;</span>
      <div id="instructionContainer">
        <!-- Instruction pour la rotation -->
        <div class="instructionRow">
          <img src="/Potree_Sncf_Projet/build/potree/resources/images/clicgauche.png" alt="Rotation" class="instructionImage">
          <div class="instructionText">
            <h3>Rotation</h3>
            <p>Cliquez et faites glisser pour faire pivoter la vue.<br>Double-cliquez pour accélérer.</p>
          </div>
        </div>
        <!-- Instruction pour le zoom -->
        <div class="instructionRow">
          <img src="/Potree_Sncf_Projet/build/potree/resources/images/clicmolette.png" alt="Zoom" class="instructionImage">
          <div class="instructionText">
            <h3>Zoom</h3>
            <p>Utilisez la molette pour zoomer et dézoomer.</p>
          </div>
        </div>
        <!-- Instruction pour le déplacement -->
        <div class="instructionRow">
          <img src="/Potree_Sncf_Projet/build/potree/resources/images/clicdroit.png" alt="Rotation" class="instructionImage">
          <div class="instructionText">
            <h3>Déplacement</h3>
            <p>Cliquez et faites glisser pour déplacer la vue.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup d'instructions avec 3 images et des phrases -->
  <div id="instructionsPopup" style="display: none;">
    <div id="instructionsPopupContent">
        <!-- Conteneur des images et des phrases -->
        <div id="popupImagesContainer">
            <!-- Image et phrase 1 -->
            <p>Contrôlez le son et naviguez dans la narration :</p>
            <img src="/Potree_Sncf_Projet/build/potree/resources/images/image-audio.png" alt="Contrôle audio">

            <!-- Image et phrase 2 -->
            <p>Explorez les différentes vues de la visite :</p>
            <img src="/Potree_Sncf_Projet/build/potree/resources/images/image-camera.png" alt="Navigation caméra">
            
            <!-- Image et phrase 3 -->
            <p>Découvrez et interagissez avec les éléments interactifs :</p>
            <img src="/Potree_Sncf_Projet/build/potree/resources/images/image-interaction.png" alt="Interaction avec éléments">
            
        </div>

        <!-- Bouton pour fermer la popup et commencer la visite -->
        <button id="startGuidedTourBtn">C'est parti !</button>
    </div>
  </div>


  <!-- Galerie d'images verticale -->
  <div id="verticalGallery">
    <span class="arrow" id="scrollUp">&#9650;</span>
    <div class="galleryItem" data-full="/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/centreLANG.jpg" data-info="Centre Henri Lang, 16 rue Chrétien de Troyes, 75012 Paris" style="display: block;">
      <img src="/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/centreLANG.jpg" alt="Vue du TGV">
    </div>
    <span class="arrow" id="scrollDown">&#9660;</span>
  </div>
    
  <!-- Lien vers le site de la SNCF avec affichage du logo -->
  <a href="https://www.sncf-reseau.com/fr" target="_blank">
    <img id="logo" src="/Potree_Sncf_Projet/build/potree/resources/images/Logo_SNCF.png" alt="Logo SNCF">
  </a>

  <!-- Bulle d'information globale (affichée lors du survol d'un élément de la galerie) -->
  <div id="globalTitleBubble"></div>

  <!-- Barre de contrôle pour la visite guidée via des hotspots -->
  <div class="hotspot-controls-bar">
    <div id="prev" class="arrow-button tooltip-container">
      <img src="/Potree_Sncf_Projet/build/potree/resources/icons/arrow_left.svg" alt="Gauche" />
      <span class="custom-tooltip">Vue précédente</span>
    </div>
    <div id="hotspots" class="hotspot-label tooltip-container">
      <span id="hotspotName">Vue d'ensemble</span>
      <span class="custom-tooltip">Recentrer la vue</span>
    </div>
    <div id="next" class="arrow-button tooltip-container">
      <img src="/Potree_Sncf_Projet/build/potree/resources/icons/arrow_right.svg" alt="Droite" />
      <span class="custom-tooltip">Vue suivante</span>
    </div>
    <div id="hotspotList" class="hotspot-list">
      <ul>
        <li><a href="#" data-hotspot-index="0">Vue d'ensemble</a></li>
        <li><a href="#" data-hotspot-index="1">Tableau 1</a></li>
        <li><a href="#" data-hotspot-index="2">Ile de France</a></li>
      </ul>
    </div>
  </div>

  <!-- Barre de contrôle audio -->
  <div id="audioBar">
    <input type="range" id="audioSeek" min="0" max="100" step="0.1" value="0">
    <button id="playPauseButton">
      <img id="playPauseIcon" src="/Potree_Sncf_Projet/build/potree/resources/icons/pause.svg" alt="Pause" style="width:16px; height:16px;">
    </button>
    <button id="muteButton">
      <img id="muteIcon" src="/Potree_Sncf_Projet/build/potree/resources/icons/volume-medium-white-icon.svg" alt="Mute" style="width:16px; height:16px;">
    </button>
  </div>

  <button id="pauseResumeButton">Pause</button>
  

  <!-- Éléments audio pour les hotspots -->
  <audio id="audioHotspot0" src="/Potree_Sncf_Projet/build/potree/resources/audio/01.mp3" preload="auto"></audio>
  <audio id="audioHotspot1" src="/Potree_Sncf_Projet/build/potree/resources/audio/02.mp3" preload="auto"></audio>
  <audio id="audioHotspot2" src="/Potree_Sncf_Projet/build/potree/resources/audio/03.mp3" preload="auto"></audio>

  <!-- Chargement des bibliothèques JavaScript -->
  <script src="/Potree_Sncf_Projet/libs/jquery/jquery-3.1.1.min.js"></script>
  <script src="/Potree_Sncf_Projet/libs/jquery-ui/jquery-ui.min.js"></script>
  <script src="/Potree_Sncf_Projet/libs/spectrum/spectrum.js"></script>
  <script src="/Potree_Sncf_Projet/libs/other/BinaryHeap.js"></script>
  <script src="/Potree_Sncf_Projet/libs/tween/tween.min.js"></script>
  <script src="/Potree_Sncf_Projet/libs/d3/d3.js"></script>
  <script src="/Potree_Sncf_Projet/libs/proj4/proj4.js"></script>
  <script src="/Potree_Sncf_Projet/libs/openlayers3/ol.js"></script>
  <script src="/Potree_Sncf_Projet/libs/i18next/i18next.js"></script>
  <script src="/Potree_Sncf_Projet/libs/jstree/jstree.js"></script>
  <script src="/Potree_Sncf_Projet/build/potree/potree.js"></script>
  <script src="/Potree_Sncf_Projet/libs/plasio/js/laslaz.js"></script>

  <!-- Script principal pour configurer Potree et charger les éléments 3D -->
  <script type="module">
    // Importation des modules Three.js et des loaders pour les modèles OBJ et MTL
    import * as THREE from "/Potree_Sncf_Projet/libs/three.js/build/three.module.js";
    import {OBJLoader} from "/Potree_Sncf_Projet/libs/three.js/loaders/OBJLoader.js";
    import {MTLLoader} from "/Potree_Sncf_Projet/libs/three.js/loaders/MTLLoader.js";
    
    // Définition des positions initiales de la caméra et de la cible
    let initialPosition = new THREE.Vector3(10.50, 8.15, 2.35);
    let initialTarget = new THREE.Vector3(4.99, 9.46, 1.72);
    let lastHotspotView = { position: initialPosition, target: initialTarget };

    // Initialisation du viewer Potree et configuration des paramètres de base
    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
    viewer.setPointBudget(2000000);
    viewer.setFOV(70);
    viewer.loadSettingsFromURL();
    viewer.setDescription("Salle du TCO du PAR de la ligne à grande vitesse Paris-Lyon");
    
    // Activation des effets EDL pour améliorer le rendu du nuage de points
    viewer.setEDLEnabled(false);
    viewer.setEDLRadius(1);
    viewer.setEDLStrength(0);
    viewer.setEDLOpacity(1);
    
    // Ajout d'une lumière ambiante dans la scène
    const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
    viewer.scene.scene.add(ambientLight);
    
    // Chargement du nuage de points via Potree.loadPointCloud
    Potree.loadPointCloud("https://storage.googleapis.com/projet-potree-sncf/metadata.json", "Salle_TCO", function(e){
      viewer.scene.addPointCloud(e.pointcloud);
      let material = e.pointcloud.material;
      material.size = 1.3;
      material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
      e.pointcloud.position.set(0, 0, 0);
    
      // Positionnement initial de la vue
      viewer.scene.view.setView(initialPosition, initialTarget);
    
      // Désactivation du mode haute qualité par défaut et mise à jour du texte du bouton
      viewer.useHQ = false;
      document.getElementById("toggleLissage").textContent = "Activer lissage";
    

      //---------------- Anotations textuelles ----------------//
      // Annotation texte 1
      let iconInfo = $(`<span>
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/info.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
      </span>`);
      let annotationTexte1 = new Potree.Annotation({
          position: new THREE.Vector3(4.84, 8.69, 1.83),
          title: iconInfo, // Ici on met l'élément HTML au lieu du texte
          description: "Un « poste tout relais à transit souple » désigne un dispositif de commande ferroviaire...",
          cameraPosition: new THREE.Vector3(5.8, 8.5, 1.86),
          cameraTarget: new THREE.Vector3(4.8, 8.7, 1.4)
      });
      annotationTexte1.visible = true;
      viewer.scene.annotations.add(annotationTexte1);
    

      //---------------- Anotations imagées ----------------//
      // Annotation Image 1
      let iconImage1 = $(`<!-- Création d'une icône image pour l'annotation --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/picture.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      iconImage1.find("img").click((event) => {
        event.stopPropagation();
        viewer.scene.view.setView(annotationImage1.cameraPosition, annotationImage1.cameraTarget, 1000);
        setTimeout(() => {
          const imageUrl = "/Potree_Sncf_Projet/build/potree/resources/images/175A0701.JPG";
          const imageDescription = "Poste tout relais à transit souple";
          $("#popupImage").attr("src", imageUrl);
          $("#popupText").text(imageDescription);
          $("#imagePopup").css("display", "flex");
        }, 2000);
      });
      let annotationImage1 = new Potree.Annotation({
        position: new THREE.Vector3(5.52, 10.17, 1.82),
        title: iconImage1,
        description: "PRS 3",
        cameraPosition: new THREE.Vector3(6.34, 9.56, 2.02),
        cameraTarget: new THREE.Vector3(5.53, 10.15, 1.40)
      });
      annotationImage1.visible = true;
      viewer.scene.annotations.add(annotationImage1);
    
      // Annotation avec image 2
      let iconImage2 = $(`<!-- Icône image pour la deuxième annotation --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/picture.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      iconImage2.find("img").click((event) => {
        event.stopPropagation();
        viewer.scene.view.setView(annotationImage2.cameraPosition, annotationImage2.cameraTarget, 1000);
        setTimeout(() => {
          const imageUrl = "/Potree_Sncf_Projet/build/potree/resources/images/175A0763.JPG";
          const imageDescription = "Région Ile de France";
          $("#popupImage").attr("src", imageUrl);
          $("#popupText").text(imageDescription);
          $("#imagePopup").css("display", "flex");
        }, 2000);
      });
      let annotationImage2 = new Potree.Annotation({
        position: new THREE.Vector3(7.48, 2, 2.10),
        title: iconImage2,
        description: "Région Ile de France",
        cameraPosition: new THREE.Vector3(7.78, 3.33, 2.03),
        cameraTarget: new THREE.Vector3(7.47, 1.99, 1.66)
      });
      annotationImage2.visible = true;
      viewer.scene.annotations.add(annotationImage2);
    
      //---------------- Liens visualisation 3D ----------------//
      // Annotation 3D 1
      let icon3D1 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_Tableau.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D1.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_Tableau.html", "_blank");
      });
      let annotation3D1 = new Potree.Annotation({
        position: new THREE.Vector3(9.38, 11.03, 2.30),
        title: icon3D1,
        description: "",
      });
      annotation3D1.visible = true;
      viewer.scene.annotations.add(annotation3D1);

      // Annotation 3D 2
      let icon3D2 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_PRS4.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D2.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_PRS4.html", "_blank");
      });
      let annotation3D2 = new Potree.Annotation({
        position: new THREE.Vector3(6.91, 11.06, 1.39),
        title: icon3D2,
        description: "",
      });
      annotation3D2.visible = true;
      viewer.scene.annotations.add(annotation3D2);

      // Annotation 3D 3
      let icon3D3 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_PRS1.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D3.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_PRS1.html", "_blank");
      });
      let annotation3D3 = new Potree.Annotation({
        position: new THREE.Vector3(4.96, 7.01, 1.39),
        title: icon3D3,
        description: "",
      });
      annotation3D3.visible = true;
      viewer.scene.annotations.add(annotation3D3);

      // Annotation 3D 4
      let icon3D4 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_PRS2.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D4.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_PRS2.html", "_blank");
      });
      let annotation3D4 = new Potree.Annotation({
        position: new THREE.Vector3(4.82, 8.71, 1.39),
        title: icon3D4,
        description: "",
      });
      annotation3D4.visible = true;
      viewer.scene.annotations.add(annotation3D4);

      // Annotation 3D 5
      let icon3D5 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_PRS3.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D5.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_PRS3.html", "_blank");
      });
      let annotation3D5 = new Potree.Annotation({
        position: new THREE.Vector3(5.55, 10.17, 1.39),
        title: icon3D5,
        description: "",
      });
      annotation3D5.visible = true;
      viewer.scene.annotations.add(annotation3D5);


      // Annotation 3D 6
      let icon3D6 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_idf.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D6.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_IDF.html", "_blank");
      });
      let annotation3D6 = new Potree.Annotation({
        position: new THREE.Vector3(6.59, 1.02, 2.35),
        title: icon3D6,
        description: "",
      });
      annotation3D6.visible = true;
      viewer.scene.annotations.add(annotation3D6);

      // Annotation 3D 7
      let icon3D7 = $(`<!-- Icône pour annotation 3D qui ouvre TCO_tab_total.html --> 
        <span>
          <img src="/Potree_Sncf_Projet/build/potree/resources/icons/3d.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
        </span>
      `);
      icon3D7.find("img").click((event) => {
        event.stopPropagation();
        window.open("TCO_tab_total.html", "_blank");
      });
      let annotation3D7 = new Potree.Annotation({
        position: new THREE.Vector3(0.95, 10.98, 1.43),
        title: icon3D7,
        description: "",
      });
      annotation3D7.visible = true;
      viewer.scene.annotations.add(annotation3D7);



      //---------------- Seuils de distance d'affichage ----------------//
      const distanceThresholdText = 5; //textes
      const distanceThresholdImage = 5; //images
      const distanceThreshold3D = 10; //liens3D
      // Mise à jour de la visibilité des annotations en fonction de la distance de la caméra
      viewer.addEventListener("update", () => {
        let cameraPos = viewer.scene.getActiveCamera().position;
        
        let distTexte1 = cameraPos.distanceTo(annotationTexte1.position);
        annotationTexte1.visible = (distTexte1 < distanceThresholdText);
        
        let distImage1 = cameraPos.distanceTo(annotationImage1.position);
        annotationImage1.visible = (distImage1 < distanceThresholdImage);
        
        let distImage2 = cameraPos.distanceTo(annotationImage2.position);
        annotationImage2.visible = (distImage2 < distanceThresholdImage);
        
        let dist3D1 = cameraPos.distanceTo(annotation3D1.position);
        annotation3D1.visible = (dist3D1 < distanceThreshold3D);
        
        let dist3D2 = cameraPos.distanceTo(annotation3D2.position);
        annotation3D2.visible = (dist3D2 < distanceThreshold3D);

        let dist3D3 = cameraPos.distanceTo(annotation3D3.position);
        annotation3D3.visible = (dist3D3 < distanceThreshold3D);

        let dist3D4 = cameraPos.distanceTo(annotation3D4.position);
        annotation3D4.visible = (dist3D4 < distanceThreshold3D);

        let dist3D5 = cameraPos.distanceTo(annotation3D5.position);
        annotation3D5.visible = (dist3D5 < distanceThreshold3D);

        let dist3D6 = cameraPos.distanceTo(annotation3D6.position);
        annotation3D6.visible = (dist3D6 < distanceThreshold3D);

        let dist3D7 = cameraPos.distanceTo(annotation3D7.position);
        annotation3D7.visible = (dist3D7 < distanceThreshold3D);
      });
    });
    


    //---------------- Début du chargement des modèles 3D (OBJ)----------------//
    {
      let manager = new THREE.LoadingManager();
      manager.onProgress = function ( item, loaded, total ) {
        console.log( item, loaded, total );
      };
      let onProgress = function ( xhr ) {
        if ( xhr.lengthComputable ) {
          let percentComplete = xhr.loaded / xhr.total * 100;
          console.log( Math.round(percentComplete, 2) + '% downloaded' );
        }
      };
      let onError = function ( xhr ) {};
    
      // Chargement du modèle 1 (tab central)
      let mtlLoader1 = new MTLLoader(manager);
      mtlLoader1.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_central/');
      mtlLoader1.load('Model_TCOcentral.mtl', function(materials) {
        materials.preload();
    
        let objLoader1 = new OBJLoader(manager);
        objLoader1.setMaterials(materials);
        objLoader1.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_central/');
        objLoader1.load('Model_TCOcentral.obj', function ( object ) {
          object.position.set(0.02, 0.02, 0);
          object.scale.set(1, 1, 1);
          object.rotation.set(0, 0, 0);
          viewer.scene.scene.add( object );
          window.objMesh1 = object;
        }, onProgress, onError );
      });

      // Chargement du modèle 2 (tab bas)
      let MTLLoader2 = new MTLLoader(manager);
      MTLLoader2.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_bas/');
      MTLLoader2.load('Model_bas.mtl', function(materials) {
        materials.preload();
        
        let OBJLoader2 = new OBJLoader(manager);
        OBJLoader2.setMaterials(materials);
        OBJLoader2.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_bas/');
        OBJLoader2.load('Model_bas.obj', function (object) {
          object.position.set(0, 0, 0);
          object.scale.set(1, 1, 1);
          object.rotation.set(0, 0, 0);
          window.objMesh2 = object;
          viewer.scene.scene.add(object);
        }, onProgress, onError);
      });

      // Chargement du modèle 3 (tab haut)
      let MTLLoader3 = new MTLLoader(manager);
      MTLLoader3.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_haut/');
      MTLLoader3.load('Model_haut.mtl', function(materials) {
        materials.preload();
        
        let OBJLoader3 = new OBJLoader(manager);
        OBJLoader3.setMaterials(materials);
        OBJLoader3.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_haut/');
        OBJLoader3.load('Model_haut.obj', function (object) {
          object.position.set(0, 0, 0);
          object.scale.set(1, 1, 1);
          object.rotation.set(0, 0, 0);
          window.objMesh3 = object;
          viewer.scene.scene.add(object);
        }, onProgress, onError);
      });

      // Chargement du modèle 4 (IDF modèle faible)
      let MTLLoader4 = new MTLLoader(manager);
      MTLLoader4.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_idf/');
      MTLLoader4.load('IDF_Model_faible.mtl', function(materials) {
        materials.preload();
        
        let OBJLoader4 = new OBJLoader(manager);
        OBJLoader4.setMaterials(materials);
        OBJLoader4.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_idf/');
        OBJLoader4.load('IDF_Model_faible.obj', function (object) {
          object.position.set(0, 0, 0);
          object.scale.set(1, 1, 1);
          object.rotation.set(0, 0, 0);
          window.objMesh4 = object;
          viewer.scene.scene.add(object);
        }, onProgress, onError);
      });

      // Chargement du modèle 5 (tableau inc)
      let MTLLoader5 = new MTLLoader(manager);
      MTLLoader5.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_inc/');
      MTLLoader5.load('Tableau_inc.mtl', function(materials) {
        materials.preload();
        
        let OBJLoader5 = new OBJLoader(manager);
        OBJLoader5.setMaterials(materials);
        OBJLoader5.setPath('/Potree_Sncf_Projet/model3D/modelOBJ/tab_inc/');
        OBJLoader5.load('Tableau_inc.obj', function (object) {
          object.position.set(0, 0, 0);
          object.scale.set(1, 1, 1);
          object.rotation.set(0, 0, 0);
          window.objMesh5 = object;
          viewer.scene.scene.add(object);
        }, onProgress, onError);
      });
    }
    //---------------- Fin du chargement des modèles 3D (OBJ)----------------//


    //---------------- Première Animation (Tableau Haut) ----------------//
    // Paramétrage de la durée de l'animation
    let animationDuration1 = 40; // Durée de la première animation en secondes
    const animation1 = new Potree.CameraAnimation(viewer);

    const positions1 = [
      new THREE.Vector3(2.49, 5.50, 2.65),
      new THREE.Vector3(1.78, 6.10, 2.65),
      new THREE.Vector3(1.35, 6.92, 2.65),
      new THREE.Vector3(1.23, 7.89, 2.65),
      new THREE.Vector3(1.31, 8.90, 2.65),
      new THREE.Vector3(1.58, 9.94, 2.65),
      new THREE.Vector3(2.00, 10.97, 2.65),
      new THREE.Vector3(2.54, 11.92, 2.65),
      new THREE.Vector3(3.26, 12.81, 2.65),
      new THREE.Vector3(3.96, 13.51, 2.65),
      new THREE.Vector3(4.80, 13.92, 2.65),
      new THREE.Vector3(5.73, 14.13, 2.65),
      new THREE.Vector3(6.66, 14.00, 2.65),
    ];

    const targets1 = [
      new THREE.Vector3(2.11, 4.85, 2.70),
      new THREE.Vector3(1.28, 5.63, 2.70),
      new THREE.Vector3(0.71, 6.67, 2.70),
      new THREE.Vector3(0.51, 7.83, 2.70),
      new THREE.Vector3(0.62, 9.01, 2.70),
      new THREE.Vector3(0.94, 10.16, 2.70),
      new THREE.Vector3(1.39, 11.24, 2.70),
      new THREE.Vector3(1.98, 12.29, 2.70),
      new THREE.Vector3(2.67, 13.24, 2.70),
      new THREE.Vector3(3.52, 14.06, 2.70),
      new THREE.Vector3(4.56, 14.61, 2.70),
      new THREE.Vector3(5.69, 14.82, 2.70),
      new THREE.Vector3(6.90, 14.65, 2.70),
    ];

    // Ajouter les points de contrôle dans la première animation
    for (let i = 0; i < positions1.length; i++) {
      const cp = animation1.createControlPoint();
      cp.position.set(positions1[i].x, positions1[i].y, positions1[i].z);
      cp.target.set(targets1[i].x, targets1[i].y, targets1[i].z);
    }

    // Ajouter la première animation de la caméra à la scène
    viewer.scene.addCameraAnimation(animation1);

    // Création du bouton pour la première animation
    let iconGoto1 = $(`<span>
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/camera.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
    </span>`);

    // Ajouter un événement de clic sur le bouton pour lancer la première animation
    iconGoto1.find("img").click((event) => {
      event.stopPropagation();
      animation1.play();  // Lancer la première animation lorsque le bouton est cliqué
    });

    // Créer une annotation pour la première animation
    let annotationGoto1 = new Potree.Annotation({
      position: new THREE.Vector3(2.65, 4.51, 2.70), // Position de l'annotation
      title: iconGoto1,
    });

    animation1.setDuration(animationDuration1); // Applique la durée définie ci-dessus

    annotationGoto1.visible = true;
    viewer.scene.annotations.add(annotationGoto1);
    animation1.setVisible(false);  // Désactive la représentation visuelle de l'animation

    // Bouton play pour la première animation
    const elPlay1 = $('input[name=play1]');
    elPlay1.click(() => {
      animation1.play();  // Démarre la première animation
    });

    //---------------- Deuxième Animation ----------------//
    // Paramétrage de la durée de la deuxième animation
    let animationDuration2 = 40; // Durée de la deuxième animation en secondes
    const animation2 = new Potree.CameraAnimation(viewer);

    const positions2 = [
      new THREE.Vector3(10.67, 6.89, 2.00),
      new THREE.Vector3(9.52, 7.84, 2.00),
      new THREE.Vector3(7.78, 8.75, 2.00),
      new THREE.Vector3(6.51, 6.73, 1.80),
      new THREE.Vector3(4.27, 5.10, 1.80),
      new THREE.Vector3(3.72, 8.42, 1.80),
      new THREE.Vector3(5.35, 11.84, 1.80),
      new THREE.Vector3(6.63, 12.46, 1.50),
      new THREE.Vector3(9.01, 10.75, 1.80),
      new THREE.Vector3(9.10, 9.84, 2.00),
      new THREE.Vector3(6.62, 8.06, 2.00),
      new THREE.Vector3(7.57, 5.64, 2.00),
      new THREE.Vector3(7.33, 4.31, 2.00),
      new THREE.Vector3(8.14, 3.12, 2.00),
      new THREE.Vector3(6.74, 3.32, 1.60),
      new THREE.Vector3(7.28, 4.82, 2.00),
      new THREE.Vector3(7.26, 8.40, 2.75),
      new THREE.Vector3(7.83, 7.90, 4.93),
    ];

    const targets2 = [
      new THREE.Vector3(0.50, 9.50, 2.24),
      new THREE.Vector3(7.89, 11.20, 1.49),
      new THREE.Vector3(5.07, 9.55, 1.59),
      new THREE.Vector3(2.52, 4.25, 1.58),
      new THREE.Vector3(0.32, 6.86, 1.72),
      new THREE.Vector3(1.63, 12.31, 1.76),
      new THREE.Vector3(4.04, 12.22, 1.16),
      new THREE.Vector3(7.47, 14.45, 2.36),
      new THREE.Vector3(10.44, 8.18, 1.55),
      new THREE.Vector3(8.57, 4.90, 1.70),
      new THREE.Vector3(6.80, 5.33, 1.96),
      new THREE.Vector3(6.60, 2.06, 1.53),
      new THREE.Vector3(7.01, 1.92, 1.57),
      new THREE.Vector3(5.43, 1.15, 1.99),
      new THREE.Vector3(5.06, 3.88, 1.94),
      new THREE.Vector3(3.38, 14.35, 1.74),
      new THREE.Vector3(2.99, 11.69, 1.26),
      new THREE.Vector3(4.91, 9.19, 1.37),
    ];

    // Ajouter les points de contrôle dans la deuxième animation
    for (let i = 0; i < positions2.length; i++) {
      const cp = animation2.createControlPoint();
      cp.position.set(positions2[i].x, positions2[i].y, positions2[i].z);
      cp.target.set(targets2[i].x, targets2[i].y, targets2[i].z);
    }

    // Ajouter la deuxième animation de la caméra à la scène
    viewer.scene.addCameraAnimation(animation2);

    // Création du bouton pour la deuxième animation
    let iconGoto2 = $(`<span>
        <img src="/Potree_Sncf_Projet/build/potree/resources/icons/camera.svg" class="annotation-action-icon" style="filter: invert(1); cursor: pointer;" />
    </span>`);

    // Ajouter un événement de clic sur le bouton pour lancer la deuxième animation
    iconGoto2.find("img").click((event) => {
      event.stopPropagation();
      animation2.play();  // Lancer la deuxième animation lorsque le bouton est cliqué
    });

    // Créer une annotation pour la deuxième animation
    let annotationGoto2 = new Potree.Annotation({
      position: new THREE.Vector3(6.64, 8.59, 0.52), // Position de l'annotation
      title: iconGoto2,
      description: "Lancer l'animation de caméra 2",
    });

    animation2.setDuration(animationDuration2); // Applique la durée définie ci-dessus

    annotationGoto2.visible = true;
    viewer.scene.annotations.add(annotationGoto2);
    animation2.setVisible(false);  // Désactive la représentation visuelle de l'animation

    // Bouton play pour la deuxième animation
    const elPlay2 = $('input[name=play2]');
    elPlay2.click(() => {
      animation2.play();  // Démarre la deuxième animation
    });

    //---------------- Fin Deuxième Animation ----------------//
    

    // Variable pour suivre l'état de l'animation
    let isAnimationPaused = false;

    // Bouton pour mettre en pause/reprendre l'animation
    document.getElementById("pauseResumeButton").addEventListener("click", function() {
        if (isAnimationPaused) {
            animation1.play();  // Reprendre l'animation 1
            animation2.play();  // Reprendre l'animation 2
            document.getElementById("pauseResumeButton").textContent = "Pause";  // Changer le texte du bouton
        } else {
            animation1.pause();  // Mettre l'animation 1 en pause
            animation2.pause();  // Mettre l'animation 2 en pause
            document.getElementById("pauseResumeButton").textContent = "Reprendre";  // Changer le texte du bouton
        }
        isAnimationPaused = !isAnimationPaused;  // Inverser l'état de l'animation
    });




      
    // Fonction pour jouer l'audio associé à un hotspot
    function playHotspotAudio(index) {
      for (let i = 0; i < 3; i++) {
        let audioElem = document.getElementById("audioHotspot" + i);
        if (audioElem) {
          audioElem.pause();
          audioElem.currentTime = 0;
        }
      }
      let currentAudio = document.getElementById("audioHotspot" + index);
      if (currentAudio) {
        window.currentHotspotAudio = currentAudio;
        currentAudio.play();
      }
    }
    
    // Définition des hotspots pour la visite guidée
    const hotspots = [
      { name: "Vue d'ensemble", position: new THREE.Vector3(8.34, 8.15, 4.92), target: new THREE.Vector3(3.31, 10.11, 1.31) },
      { name: "Tableau 1", position: new THREE.Vector3(7.9, 11, 2.27), target: new THREE.Vector3(9.24, 11.47, 1.94) },
      { name: "Ile de France", position: new THREE.Vector3(7.3, 4, 2.2), target: new THREE.Vector3(6.5, 2, 1.5) }
    ];

    // Fonction de navigation vers un hotspot donné
    function goToHotspot(index, playAudio = true) {
        if (index < 0 || index >= hotspots.length) return;
        const hp = hotspots[index];
        document.getElementById("hotspotName").textContent = hp.name;
        viewer.scene.view.setView(hp.position, hp.target, 5000);
        lastHotspotView = { position: hp.position, target: hp.target, name: hp.name };
        
        // Ne jouer l'audio que si playAudio est vrai
        if (playAudio) {
            playHotspotAudio(index);
        }
    }
    let currentHotspotIndex = 0;
    window.hotspots = hotspots;
    window.goToHotspot = goToHotspot;
    window.currentHotspotIndex = currentHotspotIndex;
  </script>
  
  <!-- Script pour gérer les interactions sur la page -->
  <script>
    // Fonction utilitaire pour formater les nombres avec des espaces
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }
    $(document).ready(function () {
      // Toggle de la slidebar
      $("#slidebarToggle").click(function () {
        $("#slidebar").toggleClass("open");
      });
      // Gestion des clics sur les en-têtes d'accordéon
      $(".accordion-header").click(function () {
        $(this).toggleClass("active");
        var content = $(this).next(".accordion-content");
        content.css("max-height", content.css("max-height") !== "0px" ? "0px" : content.prop("scrollHeight") + "px");
      });
    });
    // Gestion du bouton pour activer/désactiver le lissage (HQ)
    document.getElementById("toggleLissage").addEventListener("click", function () {
      viewer.useHQ = !viewer.useHQ;
      this.textContent = viewer.useHQ ? "Désactiver lissage" : "Activer lissage";
    });
    // Mise à jour dynamique du point budget en fonction du slider
    document.getElementById("pointBudgetSlider").addEventListener("input", function (e) {
      let val = parseInt(e.target.value);
      document.getElementById("pointBudgetValue").textContent = formatNumber(val);
      viewer.setPointBudget(val);
    });
    // Affichage en temps réel de la position de la caméra
    setInterval(function() {
      let cam = viewer.scene.getActiveCamera();
      if(cam && cam.position) {
        let x = cam.position.x.toFixed(2).replace('.', ',');
        let y = cam.position.y.toFixed(2).replace('.', ',');
        let z = cam.position.z.toFixed(2).replace('.', ',');
        document.getElementById("cameraPosition").childNodes[0].textContent =
          "X: " + x + " ; Y: " + y + " ; Z: " + z;
      }
    }, 100);
  </script>
  
  <!-- Scripts pour la gestion des mesures et des interactions sur le rendu -->
  <script>
    $(document).ready(function () {
      let measurements = [];
      // Démarrage d'une mesure lorsque le bouton est cliqué
      $('#measureButton').click(function () {
        if (viewer.measuringTool) {
          let newMeasurement = viewer.measuringTool.startInsertion({
            showDistances: false,
            showAngles: false,
            showCoordinates: true,
            showArea: false,
            closed: false,
            maxMarkers: 1,
            name: 'Point'
          });
          measurements.push(newMeasurement);
        }
      });
      // Suppression de toutes les mesures lorsque le bouton est cliqué
      $('#deleteButton').click(function () {
        if (viewer.scene) {
          viewer.scene.removeAllMeasurements();
          measurements = [];
          $('#cameraPosition').text("Toutes les mesures ont été supprimées");
        }
      });
      // Recentrement de la vue
      document.getElementById("recenterButton").addEventListener("click", function(){
        viewer.fitToScreen();
      });
      // Affichage de la popup d'instructions
      document.getElementById("instructionButton").addEventListener("click", function(){
        document.getElementById("instructionPopup").style.display = "flex";
      });
      // Bascule en mode plein écran
      document.getElementById("fullscreenButton").addEventListener("click", function(){
        toggleFullScreen();
      });
    });
  </script>
  
  <!-- Script pour gérer le mode plein écran -->
  <script>
    function toggleFullScreen() {
      var fsButtonImg = document.querySelector("#fullscreenButton img");
      // Passage en plein écran si aucun élément n'est actuellement en mode plein écran
      if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement) {
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen();
        } else if (document.documentElement.mozRequestFullScreen) {
          document.documentElement.mozRequestFullScreen();
        } else if (document.documentElement.webkitRequestFullscreen) {
          document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
        }
        // Mise à jour de l'icône pour le mode "Quitter le plein écran"
        fsButtonImg.src = "/Potree_Sncf_Projet/build/potree/resources/icons/Petit-Ecran.svg";
        fsButtonImg.alt = "Quitter le plein écran";
      } else {
        // Sortie du mode plein écran
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        }
        // Mise à jour de l'icône pour le mode "Plein écran"
        fsButtonImg.src = "/Potree_Sncf_Projet/build/potree/resources/icons/GrandEcran.svg";
        fsButtonImg.alt = "Plein écran";
      }
    }
  
    // Mise à jour de l'icône si l'utilisateur quitte le plein écran par un autre moyen
    document.addEventListener("fullscreenchange", function() {
      var fsButtonImg = document.querySelector("#fullscreenButton img");
      if (!document.fullscreenElement) {
        fsButtonImg.src = "/Potree_Sncf_Projet/build/potree/resources/icons/GrandEcran.svg";
        fsButtonImg.alt = "Plein écran";
      }
    });
  </script>
  
  <!-- Scripts pour fermer la popup d'instructions -->
  <script>
    document.querySelector(".closeInstructionPopup").addEventListener("click", function(){
      document.getElementById("instructionPopup").style.display = "none";
    });
    document.getElementById("instructionPopup").addEventListener("click", function(e){
      if(e.target === this){
        document.getElementById("instructionPopup").style.display = "none";
      }
    });
  </script>
  
  <!-- Script pour la navigation entre les hotspots de la visite guidée -->
  <script>
    document.getElementById("hotspots").addEventListener("click", function() {
      if (this.textContent.trim() === "Commencez la visite guidée") {
          currentHotspotIndex = 0;
          goToHotspot(currentHotspotIndex);
      } else {
          let hp = hotspots[currentHotspotIndex];
          viewer.scene.view.setView(hp.position, hp.target, 1000);
      }
    });

    // Navigation vers le hotspot précédent
    document.getElementById("prev").addEventListener("click", function () {
        currentHotspotIndex--;
        if (currentHotspotIndex < 0) {
            currentHotspotIndex = hotspots.length - 1;
        }
        goToHotspot(currentHotspotIndex);
    });
    
    // Navigation vers le hotspot suivant
    document.getElementById("next").addEventListener("click", function () {
        currentHotspotIndex++;
        if (currentHotspotIndex >= hotspots.length) {
            currentHotspotIndex = 0;
        }
        goToHotspot(currentHotspotIndex);
    });
  </script>
  
  <!-- Script pour gérer la galerie d'images -->
  <script>
    // Tableau contenant les images et leurs descriptions
    const images = [
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/centreLANG.jpg", info: "Centre Henri Lang, 16 rue Chrétien de Troyes, 75012 Paris" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/IMG_5673.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/28451.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/23361.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/23360.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/23356.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/23354.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/23350.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/22637.JPG", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/20907.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/20905.JPG", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/20903.JPG", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/20901.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/19134.jpg", info: "Salle du TCO en activité" },
      { src: "/Potree_Sncf_Projet/build/potree/resources/images/Photographies_histoire/19131.jpg", info: "Salle du TCO en activité" }
    ];
    let currentIndex = 0;
    // Mise à jour de l'image affichée dans la galerie
    function updateGallery() {
      const galleryItem = document.querySelector('.galleryItem');
      galleryItem.querySelector('img').src = images[currentIndex].src;
      galleryItem.setAttribute('data-info', images[currentIndex].info);
      galleryItem.setAttribute('data-full', images[currentIndex].src);
    }
    document.addEventListener('DOMContentLoaded', function () {
      // Navigation dans la galerie (image précédente)
      document.getElementById('scrollUp').addEventListener('click', function () {
        currentIndex = (currentIndex === 0) ? images.length - 1 : currentIndex - 1;
        updateGallery();
      });
      // Navigation dans la galerie (image suivante)
      document.getElementById('scrollDown').addEventListener('click', function () {
        currentIndex = (currentIndex === images.length - 1) ? 0 : currentIndex + 1;
        updateGallery();
      });
      // Gestion de l'affichage de la popup lors du clic sur un élément de la galerie
      const galleryItems = document.querySelectorAll('.galleryItem');
      const popup = document.getElementById('imagePopup');
      const popupImage = document.getElementById('popupImage');
      const popupText = document.getElementById('popupText');
      const closeBtn = document.querySelector('.closePopup');
      const globalTitleBubble = document.getElementById('globalTitleBubble');
      galleryItems.forEach(function (item) {
        item.addEventListener('click', function () {
          const fullSrc = item.getAttribute('data-full');
          const infoText = item.getAttribute('data-info');
          popupImage.src = fullSrc;
          popupText.textContent = infoText;
          popup.style.display = 'flex';
        });
        // Affichage de la bulle d'information lors du survol
        item.addEventListener('mouseenter', function () {
          const info = item.getAttribute('data-info');
          globalTitleBubble.textContent = info;
          globalTitleBubble.style.display = 'block';
          const rect = item.getBoundingClientRect();
          const bubbleRect = globalTitleBubble.getBoundingClientRect();
          const left = rect.left - bubbleRect.width - 5;
          const top = rect.top + (rect.height / 2) - (bubbleRect.height / 2);
          globalTitleBubble.style.left = left + 'px';
          globalTitleBubble.style.top = top + 'px';
        });
        item.addEventListener('mouseleave', function () {
          globalTitleBubble.style.display = 'none';
        });
      });
      // Fermeture de la popup d'image
      closeBtn.addEventListener('click', function () {
        popup.style.display = 'none';
        popupImage.src = '';
        popupText.textContent = '';
        scale = 1;
        panX = 0;
        panY = 0;
        updateTransform();
      });
      popup.addEventListener('click', function (e) {
        if (e.target === popup) {
          closeBtn.click();
        }
      });
    });
  </script>
  
  <!-- Script pour gérer la popup vidéo -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const videoThumbnail = document.getElementById('videoThumbnail');
      const videoPopup = document.getElementById('videoPopup');
      const popupVideo = document.getElementById('popupVideo');
      const closeVideoPopup = document.querySelector('.closeVideoPopup');
      
      // Sauvegarde des paramètres actuels du viewer
      let savedPointBudget = viewer ? viewer.pointBudget : 2000000;
      let savedUseHQ = viewer ? viewer.useHQ : false;
      
      // Affichage de la popup vidéo lors du clic sur la miniature
      if(videoThumbnail){
        videoThumbnail.addEventListener('click', function () {
          savedPointBudget = viewer.pointBudget;
          savedUseHQ = viewer.useHQ;
          viewer.setPointBudget(100000);
          viewer.useHQ = false;
          videoPopup.style.display = 'flex';
          popupVideo.querySelector('source').src = "https://storage.googleapis.com/projet-potree-sncf/Version%20Courte%20PAR.mp4";
          popupVideo.load();
          popupVideo.play();
        });
      }
      
      // Fermeture de la popup vidéo et restauration des paramètres
      if(closeVideoPopup){
        closeVideoPopup.addEventListener('click', function () {
          videoPopup.style.display = 'none';
          popupVideo.pause();
          popupVideo.currentTime = 0;
          popupVideo.querySelector('source').src = '';
          viewer.setPointBudget(savedPointBudget);
          viewer.useHQ = savedUseHQ;
        });
      }
      
      if(videoPopup){
        videoPopup.addEventListener('click', function (e) {
          if (e.target === videoPopup) {
            closeVideoPopup.click();
          }
        });
      }
    });
  </script>
  
  <!-- Script pour gérer le zoom et le pan sur l'image de la popup -->
  <script>
    const popupImage = document.getElementById('popupImage');
    let scale = 1, panX = 0, panY = 0;
    const zoomFactor = 1.1, maxScale = 5, minScale = 0.5;
    function updateTransform(){
      popupImage.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    }
    // Gestion du zoom à la molette
    popupImage.addEventListener('wheel', function(e) {
      e.preventDefault();
      if (e.deltaY < 0) {
        scale = Math.min(scale * zoomFactor, maxScale);
      } else {
        scale = Math.max(scale / zoomFactor, minScale);
      }
      updateTransform();
    });
    let isPanning = false, startX = 0, startY = 0;
    // Gestion du pan en cliquant et glissant sur l'image
    popupImage.addEventListener('mousedown', (e) => {
      isPanning = true;
      startX = e.clientX - panX;
      startY = e.clientY - panY;
      popupImage.style.cursor = 'grabbing';
    });
    document.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      panX = e.clientX - startX;
      panY = e.clientY - startY;
      updateTransform();
    });
    document.addEventListener('mouseup', () => {
      isPanning = false;
      popupImage.style.cursor = 'grab';
    });
    // Prévenir le comportement de glisser-déposer par défaut
    popupImage.addEventListener('dragstart', (e) => { e.preventDefault(); });
  </script>
  
  <!-- Gestion du choix du mode d'utilisation : Expert ou Visite guidée -->
  <script>
    document.getElementById('btnExpert').addEventListener('click', function() {
        document.getElementById('welcomePopup').style.display = 'none';
        
        // Masquer la barre de visite guidée et la barre audio
        document.querySelector('.hotspot-controls-bar').style.display = 'none';
        document.getElementById('audioBar').style.display = 'none';
    });
    
    document.getElementById('btnSimplified').addEventListener('click', function() {
      document.getElementById('splat_buttons').style.display = 'none';
      document.getElementById('buttonAndCameraContainer').style.display = 'none';
      viewer.useHQ = true;
      window.guidedMode = true;
      document.getElementById('welcomePopup').style.display = 'none';

      goToHotspot(0, false);

      // Afficher la popup d'instructions
      document.getElementById('instructionsPopup').style.display = 'block';
      
      const potreeContainer = document.querySelector(".potree_container");
      // Désactivation des interactions sur le conteneur Potree sauf sur les annotations
      ["mousedown", "mousemove", "mouseup", "wheel", "click"].forEach(evtType => {
        potreeContainer.addEventListener(evtType, function(e) {
          if (!e.target.closest(".annotation") && !e.target.closest(".potree_annotation")) {
            e.stopImmediatePropagation();
            e.preventDefault();
          }
        }, true);
      });
      
      // Ajustement dynamique du pointBudget en fonction du FPS
      let currentPointBudget = 1000000;
      viewer.setPointBudget(currentPointBudget);
      let lastTime = performance.now();
      let frameCount = 0;
      viewer.addEventListener("update", function() {
        frameCount++;
      });
      setInterval(function() {
        if (window.guidedMode) {
          let now = performance.now();
          let delta = (now - lastTime) / 1000;
          let fps = frameCount / delta;
          console.log("FPS mesuré : " + fps.toFixed(2));
          if (fps < 15) {
            currentPointBudget = Math.max(currentPointBudget * 0.8, 100000);
            console.log("Réduction du pointBudget à " + currentPointBudget);
            viewer.setPointBudget(currentPointBudget);
          } else if (fps > 30) {
            currentPointBudget = Math.min(currentPointBudget * 1.2, 10000000);
            console.log("Augmentation du pointBudget à " + currentPointBudget);
            viewer.setPointBudget(currentPointBudget);
          }
          frameCount = 0;
          lastTime = now;
        }
      }, 1000);
    });
  </script>


  <!-- Gestion du Popup d'instruction de visite guidée -->
  <script>
    document.getElementById('startGuidedTourBtn').addEventListener('click', function() {
        // Fermer la popup d'instructions
        document.getElementById('instructionsPopup').style.display = 'none';

        // Lancer normalement la visite guidée (y compris l'audio et la navigation entre les hotspots)
        goToHotspot(0, true);  // Retour au premier hotspot
    });
  </script>
  
  <!-- Masquage de l'écran de chargement une fois la page chargée -->
  <script>
    window.addEventListener('load', function () {
      setTimeout(function(){
        document.getElementById('splash').style.display = 'none';
      }, 0);
    });
  </script>
  
  <!-- Gestion des contrôles audio -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const audioSeek = document.getElementById('audioSeek');
      const playPauseButton = document.getElementById('playPauseButton');
      const muteButton = document.getElementById('muteButton');
      let isMuted = false;
      // Synchronisation du slider audio avec l'avancement de l'audio
      audioSeek.addEventListener('input', function () {
        if (window.currentHotspotAudio && window.currentHotspotAudio.duration) {
          window.currentHotspotAudio.currentTime = (this.value / 100) * window.currentHotspotAudio.duration;
        }
      });
      setInterval(function () {
        if (window.currentHotspotAudio && window.currentHotspotAudio.duration) {
          audioSeek.value = (window.currentHotspotAudio.currentTime / window.currentHotspotAudio.duration) * 100;
        }
      }, 100);
      // Gestion du bouton play/pause pour l'audio
      playPauseButton.addEventListener('click', function () {
        if (window.currentHotspotAudio) {
          if (window.currentHotspotAudio.paused) {
            window.currentHotspotAudio.play();
            document.getElementById('playPauseIcon').src = "/Potree_Sncf_Projet/build/potree/resources/icons/pause.svg";
            document.getElementById('playPauseIcon').alt = "Pause";
          } else {
            window.currentHotspotAudio.pause();
            document.getElementById('playPauseIcon').src = "/Potree_Sncf_Projet/build/potree/resources/icons/play.svg";
            document.getElementById('playPauseIcon').alt = "Play";
          }
        }
      });
      // Gestion du bouton mute/unmute pour l'audio
      muteButton.addEventListener('click', function () {
        isMuted = !isMuted;
        const audios = [
          document.getElementById('audioHotspot0'),
          document.getElementById('audioHotspot1'),
          document.getElementById('audioHotspot2')
        ];
        audios.forEach(audio => {
          if (audio) {
            audio.muted = isMuted;
          }
        });
        if (isMuted) {
          document.getElementById('muteIcon').src = "/Potree_Sncf_Projet/build/potree/resources/icons/volume-silent-white-icon.svg";
          document.getElementById('muteIcon').alt = "Unmute";
        } else {
          document.getElementById('muteIcon').src = "/Potree_Sncf_Projet/build/potree/resources/icons/volume-medium-white-icon.svg";
          document.getElementById('muteIcon').alt = "Mute";
        }
      });
    });
  </script>
  
</body>
</html>
